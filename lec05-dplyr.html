<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Tidying and exporting data, reproducing figures</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<style type="text/css">

table {
    border-collapse: collapse;
}

thead {
    border-top: solid #DCDCDC;
    border-bottom: solid #DCDCDC;
}

tr.odd {
    background-color: #F8F8F8;
}

tr:last-child {
    border-bottom: solid #DCDCDC;
}

</style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 54px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 59px;
  margin-top: -59px;
}

.section h2 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h3 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h4 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h5 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h6 {
  padding-top: 59px;
  margin-top: -59px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">EEB430H1</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-map-o"></span>
     
    Syllabus
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lec01-introduction.html">Sept. 7: Intro to course, programming, RStudio, and R Markdown</a>
    </li>
    <li>
      <a href="lec02-basic-r.html">Sept. 12: Variable assignment, vectors, functions</a>
    </li>
    <li>
      <a href="lec03-basic-r.html">Sept. 14: Data frames, intro to dplyr</a>
    </li>
    <li>
      <a href="lec04-dplyr.html">Sept. 19: Data wrangling in dplyr, tidy data</a>
    </li>
    <li>
      <a href="lec05-dplyr.html">Sept. 21: More dplyr and tidy data, ggplot intro</a>
    </li>
    <li>
      <a href="lec06-pop-models.html">Sept. 26: Qualitative review of population models</a>
    </li>
    <li>
      <a href="lec07-pop-models.html">Sept. 28: Modelling in R</a>
    </li>
    <li>
      <a href="lec08-stability.html">Oct. 03: Population models in 2 dimensions</a>
    </li>
    <li>
      <a href="lec09-modeling-r.html">Oct. 05: Fixed points, null clines, and stability</a>
    </li>
    <li>
      <a href="lec10-modeling.html">Oct. 10: Fitting models to data</a>
    </li>
    <li>
      <a href="lec11-modeling-r.html">Oct. 12: Statistical/probabilistic modelling in R</a>
    </li>
    <li>
      <a href="lec12-datasets.html">Oct. 17: Introduce data sets, hypotheses, start projects</a>
    </li>
    <li>
      <a href="lec13-projects-r.html">Oct. 19: Project and Git setup in RStudio, tidy data, and project work</a>
    </li>
    <li>
      <a href="lec14-git.html">Oct. 24: Scientific collaboration, Git and GitHub</a>
    </li>
    <li>
      <a href="lec15-data-viz.html">Oct. 26: Data visualization (Part 2) and project work</a>
    </li>
    <li>
      <a href="lec16-data-viz.html">Oct. 31: Project work, data visualizations</a>
    </li>
    <li>
      <a href="lec17-rmarkdown.html">Nov. 02: Reproducible workflow, metadata, R Markdown</a>
    </li>
    <li>
      <a href="lec18-metadata.html">Nov. 14: Metadata and project work</a>
    </li>
    <li class="dropdown-header">Nov. 16: Project work (no lesson)</li>
    <li>
      <a href="lec19-publishing.html">Nov. 21: Preparing a scientific item for academic publishing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="assignment-01.html">Assignment 1</a>
    </li>
    <li>
      <a href="assignment-02.html">Assignment 2</a>
    </li>
    <li>
      <a href="assignment-03.html">Assignment 3</a>
    </li>
    <li>
      <a href="assignment-04.html">Assignment 4</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-caret-square-o-right"></span>
     
    Slides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header"></li>
  </ul>
</li>
<li>
  <a href="resources.html">
    <span class="fa fa-question"></span>
     
    Resources and FAQ
  </a>
</li>
<li>
  <a href="about.html">
    <span class="fa fa-info"></span>
     
    About
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bars"></span>
     
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="mailto:joel.ostblom@mail.utoronto.ca">
        <span class="fa fa-envelope"></span>
         
        Contact
      </a>
    </li>
    <li>
      <a href="https://github.com/uoftcoders/rcourse">
        <span class="fa fa-github"></span>
         
        GitHub
      </a>
    </li>
  </ul>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Tidying and exporting data, reproducing figures</h1>

</div>


<blockquote>
<h3 id="lecture-objectives">Lecture objectives</h3>
<ul>
<li>Learn about tidy data.</li>
<li>Transform data from the long to wide format.</li>
<li>Reproduce existing figures from raw data.</li>
<li>Understand which raw data is underlying a figure.</li>
<li>Understand which types of figures are suitable to create from raw data.</li>
<li>Explore scientific questions using dplyr and ggplot.</li>
</ul>
<h3 id="lecture-outline">Lecture outline</h3>
<ul>
<li>Reshaping with gather and spread (25 min)</li>
<li>Exporting data (15 min)</li>
<li>Reproducing figures (50 min)</li>
</ul>
</blockquote>
<div id="setting-up" class="section level2">
<h2>Setting up</h2>
<p>Start by loading the required packages. Both <strong><code>ggplot2</code></strong> and <strong><code>dplyr</code></strong> are included in the <strong><code>tidyverse</code></strong> package collection.</p>
<pre class="r"><code># Install if needed
# install.packages(&#39;tidyverse&#39;)
library(tidyverse)</code></pre>
<p>Load the data we saved in the previous lesson.</p>
<pre class="r"><code># Download if needed
# download.file(&quot;https://ndownloader.figshare.com/files/2292169&quot;, &quot;portal_data.csv&quot;)
surveys &lt;- read_csv(&#39;portal_data.csv&#39;)</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   record_id = col_integer(),
##   month = col_integer(),
##   day = col_integer(),
##   year = col_integer(),
##   plot_id = col_integer(),
##   species_id = col_character(),
##   sex = col_character(),
##   hindfoot_length = col_integer(),
##   weight = col_integer(),
##   genus = col_character(),
##   species = col_character(),
##   taxa = col_character(),
##   plot_type = col_character()
## )</code></pre>
<pre class="r"><code>surveys</code></pre>
<pre><code>## # A tibble: 34,786 x 13
##    record_id month   day  year plot_id species_id   sex hindfoot_length
##        &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;      &lt;chr&gt; &lt;chr&gt;           &lt;int&gt;
##  1         1     7    16  1977       2         NL     M              32
##  2        72     8    19  1977       2         NL     M              31
##  3       224     9    13  1977       2         NL  &lt;NA&gt;              NA
##  4       266    10    16  1977       2         NL  &lt;NA&gt;              NA
##  5       349    11    12  1977       2         NL  &lt;NA&gt;              NA
##  6       363    11    12  1977       2         NL  &lt;NA&gt;              NA
##  7       435    12    10  1977       2         NL  &lt;NA&gt;              NA
##  8       506     1     8  1978       2         NL  &lt;NA&gt;              NA
##  9       588     2    18  1978       2         NL     M              NA
## 10       661     3    11  1978       2         NL  &lt;NA&gt;              NA
## # ... with 34,776 more rows, and 5 more variables: weight &lt;int&gt;,
## #   genus &lt;chr&gt;, species &lt;chr&gt;, taxa &lt;chr&gt;, plot_type &lt;chr&gt;</code></pre>
</div>
<div id="reshaping-with-gather-and-spread" class="section level2">
<h2>Reshaping with gather and spread</h2>
<p><strong><code>dplyr</code></strong> is one part of a larger <strong><code>tidyverse</code></strong> that enables you to work with data in tidy data formats. <strong><code>tidyr</code></strong> enables a wide range of manipulations of the structure data itself. For example, the survey data presented here is almost in what we call a <strong>long</strong> format - every observation of every individual is its own row. This is an ideal format for data with a rich set of information per observation. It makes it difficult, however, to look at the relationships between measurements across plots. For example, what is the relationship between mean weights of different genera across the entire data set?</p>
<p>To answer that question, we’d want each plot to have a single row, with all of the measurements in a single plot having their own column. This is called a <strong>wide</strong> data format. For the <code>surveys</code> data as we have it right now, this is going to be one heck of a wide data frame! However, if we were to summarize data within plots and species, we might begin to have some relationships we’d want to examine.</p>
<p>Let’s see this in action. First, using <strong><code>dplyr</code></strong>, let’s create a data frame with the mean body weight of each genus by plot.</p>
<pre class="r"><code>surveys_gw &lt;- surveys %&gt;%
    filter(!is.na(weight)) %&gt;%
    group_by(genus, plot_id) %&gt;%
    summarize(mean_weight = mean(weight))

head(surveys_gw)</code></pre>
<pre><code>## # A tibble: 6 x 3
## # Groups:   genus [1]
##     genus plot_id mean_weight
##     &lt;chr&gt;   &lt;int&gt;       &lt;dbl&gt;
## 1 Baiomys       1    7.000000
## 2 Baiomys       2    6.000000
## 3 Baiomys       3    8.611111
## 4 Baiomys       5    7.750000
## 5 Baiomys      18    9.500000
## 6 Baiomys      19    9.533333</code></pre>
<div id="long-to-wide-with-spread" class="section level3">
<h3>Long to Wide with <code>spread</code></h3>
<p>Now, to make this long data wide, we use <code>spread</code> from <code>tidyr</code> to spread out the different taxa into columns. <code>spread</code> takes three arguments: - the data, the <em>key</em> column (or column with identifying information), the <em>values</em> column (the one with the numbers/values). We’ll use a pipe so we can ignore the data argument.</p>
<pre class="r"><code>surveys_gw_wide &lt;- surveys_gw %&gt;%
  spread(genus, mean_weight)

head(surveys_gw_wide)</code></pre>
<pre><code>## # A tibble: 6 x 11
##   plot_id  Baiomys Chaetodipus Dipodomys  Neotoma Onychomys Perognathus
##     &lt;int&gt;    &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;
## 1       1 7.000000    22.19939  60.23214 156.2222  27.67550    9.625000
## 2       2 6.000000    25.11014  55.68259 169.1436  26.87302    6.947368
## 3       3 8.611111    24.63636  52.04688 158.2414  26.03241    7.507812
## 4       4       NA    23.02381  57.52454 164.1667  28.09375    7.824427
## 5       5 7.750000    17.98276  51.11356 190.0370  27.01695    8.658537
## 6       6       NA    24.86009  58.60531 179.9333  25.89947    7.809524
## # ... with 4 more variables: Peromyscus &lt;dbl&gt;, Reithrodontomys &lt;dbl&gt;,
## #   Sigmodon &lt;dbl&gt;, Spermophilus &lt;dbl&gt;</code></pre>
<p>Notice that some genera have <code>NA</code> values. That’s because some of those genera don’t have any record in that plot. Sometimes it is fine to leave those as <code>NA</code>. Sometimes we want to fill them as zeros, in which case we would add the argument <code>fill=0</code>.</p>
<pre class="r"><code>surveys_gw %&gt;%
  spread(genus, mean_weight, fill = 0) %&gt;%
  head</code></pre>
<pre><code>## # A tibble: 6 x 11
##   plot_id  Baiomys Chaetodipus Dipodomys  Neotoma Onychomys Perognathus
##     &lt;int&gt;    &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;
## 1       1 7.000000    22.19939  60.23214 156.2222  27.67550    9.625000
## 2       2 6.000000    25.11014  55.68259 169.1436  26.87302    6.947368
## 3       3 8.611111    24.63636  52.04688 158.2414  26.03241    7.507812
## 4       4 0.000000    23.02381  57.52454 164.1667  28.09375    7.824427
## 5       5 7.750000    17.98276  51.11356 190.0370  27.01695    8.658537
## 6       6 0.000000    24.86009  58.60531 179.9333  25.89947    7.809524
## # ... with 4 more variables: Peromyscus &lt;dbl&gt;, Reithrodontomys &lt;dbl&gt;,
## #   Sigmodon &lt;dbl&gt;, Spermophilus &lt;dbl&gt;</code></pre>
<p>We can now do things like plot the weight of <em>Baiomys</em> against <em>Chaetodipus</em> or examine their correlation.</p>
<pre class="r"><code>surveys_gw %&gt;%
  spread(genus, mean_weight, fill = 0) %&gt;%
  cor(use = &quot;pairwise.complete&quot;)</code></pre>
<pre><code>##                    plot_id     Baiomys Chaetodipus    Dipodomys
## plot_id          1.0000000 -0.11041371   0.2945925 -0.165214440
## Baiomys         -0.1104137  1.00000000   0.3687496 -0.050774964
## Chaetodipus      0.2945925  0.36874958   1.0000000  0.325918149
## Dipodomys       -0.1652144 -0.05077496   0.3259181  1.000000000
## Neotoma         -0.5505067 -0.03268885  -0.2764929  0.121595440
## Onychomys       -0.4805452 -0.08689875  -0.3254973  0.093274704
## Perognathus      0.2468167  0.16572228   0.1799742  0.134225846
## Peromyscus      -0.3042821  0.10570094   0.2109187  0.219996783
## Reithrodontomys -0.2693462  0.34710430  -0.2258934 -0.142993836
## Sigmodon         0.2745083 -0.01421689   0.1971181 -0.092613012
## Spermophilus     0.1342651 -0.05423613  -0.3096137 -0.003720851
##                     Neotoma   Onychomys Perognathus Peromyscus
## plot_id         -0.55050668 -0.48054516   0.2468167 -0.3042821
## Baiomys         -0.03268885 -0.08689875   0.1657223  0.1057009
## Chaetodipus     -0.27649287 -0.32549730   0.1799742  0.2109187
## Dipodomys        0.12159544  0.09327470   0.1342258  0.2199968
## Neotoma          1.00000000  0.43466237  -0.2562367  0.3072292
## Onychomys        0.43466237  1.00000000  -0.1929882  0.1146881
## Perognathus     -0.25623672 -0.19298820   1.0000000  0.1813099
## Peromyscus       0.30722919  0.11468812   0.1813099  1.0000000
## Reithrodontomys  0.31713778 -0.03186637  -0.2796847  0.2924641
## Sigmodon         0.04665664 -0.19977238  -0.2493341  0.1562804
## Spermophilus    -0.14037233  0.37939827   0.1057038 -0.1593698
##                 Reithrodontomys    Sigmodon Spermophilus
## plot_id             -0.26934622  0.27450825  0.134265067
## Baiomys              0.34710430 -0.01421689 -0.054236130
## Chaetodipus         -0.22589344  0.19711806 -0.309613679
## Dipodomys           -0.14299384 -0.09261301 -0.003720851
## Neotoma              0.31713778  0.04665664 -0.140372334
## Onychomys           -0.03186637 -0.19977238  0.379398267
## Perognathus         -0.27968468 -0.24933409  0.105703800
## Peromyscus           0.29246412  0.15628042 -0.159369768
## Reithrodontomys      1.00000000  0.16463343 -0.217470366
## Sigmodon             0.16463343  1.00000000 -0.270401476
## Spermophilus        -0.21747037 -0.27040148  1.000000000</code></pre>
</div>
<div id="wide-to-long-with-gather" class="section level3">
<h3>Wide to long with <code>gather</code></h3>
<p>What if we had the opposite problem, and wanted to go from a wide to long format? For that, we use <code>gather</code> to sweep up a set of columns into one key-value pair. We give it the arguments of a new key and value column name, and then we specify which columns we either want or do not want gathered up. So, to go backwards from <code>surveys_gw_wide</code>, and exclude <code>plot_id</code> from the gathering, we would do the following:</p>
<pre class="r"><code>surveys_gw_long &lt;- surveys_gw_wide %&gt;%
  gather(genus, mean_weight, -plot_id)

head(surveys_gw_long)</code></pre>
<pre><code>## # A tibble: 6 x 3
##   plot_id   genus mean_weight
##     &lt;int&gt;   &lt;chr&gt;       &lt;dbl&gt;
## 1       1 Baiomys    7.000000
## 2       2 Baiomys    6.000000
## 3       3 Baiomys    8.611111
## 4       4 Baiomys          NA
## 5       5 Baiomys    7.750000
## 6       6 Baiomys          NA</code></pre>
<p>Note that now the <code>NA</code> genera are included in the long format. Going from wide to long to wide can be a useful way to balance out a dataset so every replicate has the same composition.</p>
<p>We could also have used a specification for what columns to include. This can be useful if you have a large number of identifying columns, and it’s easier to specify what to gather than what to leave alone. And if the columns are sequential, we don’t even need to list them all out - just use the <code>:</code> operator!</p>
<pre class="r"><code>surveys_gw_wide %&gt;%
  gather(genus, mean_weight, Baiomys:Spermophilus) %&gt;%
  head()</code></pre>
<pre><code>## # A tibble: 6 x 3
##   plot_id   genus mean_weight
##     &lt;int&gt;   &lt;chr&gt;       &lt;dbl&gt;
## 1       1 Baiomys    7.000000
## 2       2 Baiomys    6.000000
## 3       3 Baiomys    8.611111
## 4       4 Baiomys          NA
## 5       5 Baiomys    7.750000
## 6       6 Baiomys          NA</code></pre>
<blockquote>
<h3 id="challenge">Challenge</h3>
<ol style="list-style-type: decimal">
<li><p>Make a wide data frame with <code>year</code> as columns, <code>plot_id</code> as rows, and the values are the number of genera per plot. You will need to summarize before reshaping, and use the function <code>n_distinct</code> to get the number of unique types of a genus. It’s a powerful function! See <code>?n_distinct</code> for more.</p></li>
<li><p>Now take that data frame, and make it long again, so each row is a unique <code>plot_id</code> - <code>year</code> combination.</p></li>
<li><p>The <code>surveys</code> data set is not truly wide or long because there are two columns of measurement - <code>hindfoot_length</code> and <code>weight</code>. This makes it difficult to do things like look at the relationship between mean values of each measurement per year in different plot types. Let’s walk through a common solution for this type of problem. First, use <code>gather</code> to create a truly long dataset where we have a key column called <code>measurement</code> and a <code>value</code> column that takes on the value of either <code>hindfoot_length</code> or <code>weight</code>. Hint: You’ll need to specify which columns are being gathered.</p></li>
<li><p>With this new truly long data set, calculate the average of each <code>measurement</code> in each <code>year</code> for each different <code>plot_type</code>. Then <code>spread</code> them into a wide data set with a column for <code>hindfoot_length</code> and <code>weight</code>. Hint: Remember, you only need to specify the key and value columns for <code>spread</code>.</p></li>
</ol>
</blockquote>
<!---
  
  ```
  ## # A tibble: 6 x 27
  ## # Groups:   plot_id [6]
  ##   plot_id `1977` `1978` `1979` `1980` `1981` `1982` `1983` `1984` `1985`
  ##     <int>  <int>  <int>  <int>  <int>  <int>  <int>  <int>  <int>  <int>
  ## 1       1      2      3      4      7      5      6      7      6      4
  ## 2       2      6      6      6      8      5      9      9      9      6
  ## 3       3      5      6      4      6      6      8     10     11      7
  ## 4       4      4      4      3      4      5      4      6      3      4
  ## 5       5      4      3      2      5      4      6      7      7      3
  ## 6       6      3      4      3      4      5      9      9      7      5
  ## # ... with 17 more variables: `1986` <int>, `1987` <int>, `1988` <int>,
  ## #   `1989` <int>, `1990` <int>, `1991` <int>, `1992` <int>, `1993` <int>,
  ## #   `1994` <int>, `1995` <int>, `1996` <int>, `1997` <int>, `1998` <int>,
  ## #   `1999` <int>, `2000` <int>, `2001` <int>, `2002` <int>
  ```
  
  ```
  ## # A tibble: 624 x 3
  ## # Groups:   plot_id [24]
  ##    plot_id  year n_genera
  ##      <int> <chr>    <int>
  ##  1       1  1977        2
  ##  2       2  1977        6
  ##  3       3  1977        5
  ##  4       4  1977        4
  ##  5       5  1977        4
  ##  6       6  1977        3
  ##  7       7  1977        3
  ##  8       8  1977        2
  ##  9       9  1977        3
  ## 10      10  1977        1
  ## # ... with 614 more rows
  ```
  
  ```
  ## # A tibble: 130 x 4
  ## # Groups:   year [26]
  ##     year                 plot_type hindfoot_length   weight
  ##  * <int>                     <chr>           <dbl>    <dbl>
  ##  1  1977                   Control        36.13483 50.44094
  ##  2  1977  Long-term Krat Exclosure        33.70833 34.78947
  ##  3  1977          Rodent Exclosure        39.10000 48.20000
  ##  4  1977 Short-term Krat Exclosure        35.84884 41.27119
  ##  5  1977         Spectab exclosure        37.23913 47.12903
  ##  6  1978                   Control        38.06467 70.75169
  ##  7  1978  Long-term Krat Exclosure        22.56667 35.93548
  ##  8  1978          Rodent Exclosure        37.83077 67.27536
  ##  9  1978 Short-term Krat Exclosure        36.87432 63.80347
  ## 10  1978         Spectab exclosure        42.28448 80.13223
  ## # ... with 120 more rows
  ```
--->
</div>
</div>
<div id="exporting-data" class="section level2">
<h2>Exporting data</h2>
<p>Now that you have learned how to use <strong><code>dplyr</code></strong> to extract information from or summarize your raw data, you may want to export these new datasets to share them with your collaborators or for archival.</p>
<p>Similar to the <code>read_csv()</code> function used for reading CSV files into R, there is a <code>write_csv()</code> function that generates CSV files from data frames.</p>
<p>Before using <code>write_csv()</code>, we are going to create a new folder, <code>data-processed</code>, in our working directory that will store this generated dataset. We don’t want to store manipulated datasets in the same directory as our raw data. It’s good practice to keep them separate. The raw data would ideally be put in a <code>data-raw</code> folder, which should only contain the raw, unaltered data, and should be left alone to make sure we don’t delete or modify it from how it was when we downloaded or recorded it ourself. In contrast, our R code will create the contents of the <code>data-processed</code> directory, so even if the files it contains are deleted, we can always re-generate them.</p>
<p>Use the <code>getwd()</code> function to find out which is the current working directory.</p>
<pre class="r"><code>getwd()</code></pre>
<pre><code>## [1] &quot;/home/travis/build/UofTCoders/rcourse&quot;</code></pre>
<p>Navigate to this directory in your file browser and create a folder called <code>data-processed</code>.</p>
<p>Alternatively, you could use R to create this directory.</p>
<pre class="r"><code>dir.create(&quot;data-processed&quot;)

# To suppress the warning, we could do
dir.create(&quot;data-processed&quot;, showWarnings = FALSE)

# Another alternative would be to use a conditional expression, which only
# creates the directory *if* it does not already exist. The syntax here is
# similar to the for loop we created in the second lecture.
if (!dir.exists(&#39;data-processed&#39;)) {
    dir.create(&quot;data-processed&quot;)
}</code></pre>
<p>We are going to prepare a cleaned up version of the data without NAs. Let’s start by removing observations for which the <code>species_id</code> is missing. Let’s also remove observations for which <code>weight</code> and the <code>hindfoot_length</code> are missing. This dataset should also only contain observations of animals for which the sex has been determined:</p>
<pre class="r"><code>surveys_complete &lt;- surveys %&gt;%
  filter(!is.na(species_id),       # remove missing species_id
         !is.na(weight),           # remove missing weight
         !is.na(hindfoot_length),  # remove missing hindfoot_length
         !is.na(sex))              # remove missing sex

# This expression is a succinct alternative to the above
surveys_complete_comcas &lt;- surveys %&gt;%
    filter(complete.cases(species_id, weight, hindfoot_length, sex))

# This is even briefer, but omits observations with NA in *any* column.
# There is no way to control which columns to use, but it is common to want
# to exclude all NAs, which in our case corresponds to the columns listed above.
surveys_complete_naomit &lt;- na.omit(surveys)

# Compare the dimensions of the original and the cleaned data frame
dim(surveys)</code></pre>
<pre><code>## [1] 34786    13</code></pre>
<pre class="r"><code>dim(surveys_complete)</code></pre>
<pre><code>## [1] 30676    13</code></pre>
<pre class="r"><code>dim(surveys_complete_comcas)</code></pre>
<pre><code>## [1] 30676    13</code></pre>
<pre class="r"><code>dim(surveys_complete_naomit)</code></pre>
<pre><code>## [1] 30676    13</code></pre>
<p>Now that our dataset is ready, we can save it as a CSV file in our <code>data-processed</code> folder.</p>
<pre class="r"><code>write_csv(surveys_complete, path = &quot;data-processed/surveys_complete.csv&quot;)</code></pre>
</div>
<div id="team-challenges" class="section level2">
<h2>Team Challenges</h2>
<p>These are four exercises in exploratory data analyses, which will train you to think about data and to use the tools you have been learning about in this class to solve scientific questions and to reproduce figures from the literature. To solve these challenges, you will need to understand what data underlies a figure and how you need to manipulate it to recreate the figure.</p>
<div id="setting-up-1" class="section level3">
<h3>Setting up</h3>
<p>Start by loading the required packages. Both <strong><code>ggplot2</code></strong> and <strong><code>dplyr</code></strong> are included in the <strong><code>tidyverse</code></strong> package collection.</p>
<pre class="r"><code># Install if needed
# install.packages(&#39;tidyverse&#39;)
library(tidyverse)</code></pre>
</div>
<div id="explore-the-weight-and-hindfoot-trends-further" class="section level3">
<h3>1. Explore the weight and hindfoot trends further</h3>
<p>Load the data we saved in the previous lesson.</p>
<pre class="r"><code># Download if needed
# download.file(&quot;https://ndownloader.figshare.com/files/2292169&quot;, &quot;data/portal_data.csv&quot;)
surveys &lt;- read_csv(&#39;portal_data.csv&#39;)</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   record_id = col_integer(),
##   month = col_integer(),
##   day = col_integer(),
##   year = col_integer(),
##   plot_id = col_integer(),
##   species_id = col_character(),
##   sex = col_character(),
##   hindfoot_length = col_integer(),
##   weight = col_integer(),
##   genus = col_character(),
##   species = col_character(),
##   taxa = col_character(),
##   plot_type = col_character()
## )</code></pre>
<pre class="r"><code>surveys</code></pre>
<pre><code>## # A tibble: 34,786 x 13
##    record_id month   day  year plot_id species_id   sex hindfoot_length
##        &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;      &lt;chr&gt; &lt;chr&gt;           &lt;int&gt;
##  1         1     7    16  1977       2         NL     M              32
##  2        72     8    19  1977       2         NL     M              31
##  3       224     9    13  1977       2         NL  &lt;NA&gt;              NA
##  4       266    10    16  1977       2         NL  &lt;NA&gt;              NA
##  5       349    11    12  1977       2         NL  &lt;NA&gt;              NA
##  6       363    11    12  1977       2         NL  &lt;NA&gt;              NA
##  7       435    12    10  1977       2         NL  &lt;NA&gt;              NA
##  8       506     1     8  1978       2         NL  &lt;NA&gt;              NA
##  9       588     2    18  1978       2         NL     M              NA
## 10       661     3    11  1978       2         NL  &lt;NA&gt;              NA
## # ... with 34,776 more rows, and 5 more variables: weight &lt;int&gt;,
## #   genus &lt;chr&gt;, species &lt;chr&gt;, taxa &lt;chr&gt;, plot_type &lt;chr&gt;</code></pre>
<p>Let’s recreate the survey data set we used in lecture 4, only containing the most abundant species (those with &gt; 800 observations).</p>
<pre class="r"><code>abundant_species &lt;- surveys %&gt;%
    filter(!is.na(hindfoot_length) &amp; !is.na(weight)) %&gt;%
    group_by(species) %&gt;%
    tally() %&gt;%
    arrange(desc(n)) %&gt;%
    filter(n &gt; 800) %&gt;%
    select(species)

surveys_abun_species &lt;- surveys %&gt;%
    filter(!is.na(hindfoot_length) &amp;
        !is.na(weight) &amp;
        species %in% abundant_species$species)


# If everything loaded correctly, the dimensions of your data set should be
# 30,320 rows x 13 columns. We could check this by displaying the entire data
# set with `surveys_abun_species`, but also more directly by comparing the
# dimensions of the data set to those listed above.
dim(surveys_abun_species) == c(30320, 13)</code></pre>
<pre><code>## [1] TRUE TRUE</code></pre>
<pre class="r"><code># Remember that `==` is for comparisons, and `=` is for assigning arguments in
# function calls.</code></pre>
<p>In the second question in the last challenge of lecture 4, we saw that the average weight of all the animals decreased over time, while the average weight for each species remained constant. Here are those plots again.</p>
<pre class="r"><code>surveys_abun_species %&gt;%
    filter(!is.na(weight)) %&gt;%
    group_by(year) %&gt;%
    summarize(mean_weight = mean(weight)) %&gt;%
    ggplot(aes(x = year, y = mean_weight)) +
        geom_line()</code></pre>
<p><img src="lec05-dplyr_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<pre class="r"><code>surveys_abun_species %&gt;%
    filter(!is.na(weight)) %&gt;%
    group_by(year, species) %&gt;%
    summarize(mean_weight = mean(weight)) %&gt;%
    ggplot(aes(x = year, y = mean_weight, color = species)) +
        geom_line() +
        facet_wrap(~ species)</code></pre>
<p><img src="lec05-dplyr_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>If you were to look at the average hindfoot length over time, you would find that the trends are similar to those of the average weight. Can you find an explanation for why both the average hindfoot length and the average weight decrease over time for all animals’ average weight, but remain constant when looking at individual species? Phrased another way: since each species displays constant weight and hindfoot_length measures over time, what could be the cause of the notable decrease over time for the average weight of all species pooled together?</p>
</div>
<div id="reproduce-figure-3-from-the-paper" class="section level3">
<h3>2. Reproduce figure 3 from the paper</h3>
<p>For this section, you will apply your data wrangling and plotting skills to reproduce a couple of figures from a study on the yearly change in biomass of plants in the Abisko national park in northern Sweden. This paper is publish under an open license and the <a href="http://rstb.royalsocietypublishing.org/content/368/1624/20120486.figures-only">figures can be accessed via this link</a>.</p>
<p>You will be working with this dataset in assignment 3, so we have prepared the data for you in a format that is easier to work with. <a href="https://raw.githubusercontent.com/UofTCoders/council/master/datasets/joel/plant-biomass-preprocess.csv">Download the data</a> and read it into a dataframe called <code>plant_biomass</code>. Confirm that the data frame is 180 rows by 10 columns</p>
<p>Reproduce figure 3 from the paper. Focus on the overall message on the plot, i.e. two panels for different habitats of the plant biomass over the year in grazed controls vs rodent exclosures. You do not need to get the figure aesthetics to look exactly the same as in the published figures (i.e. no need for the exact colors and shapes, axis styles, or to include the small dots around the main lines).</p>
</div>
<div id="reproduce-figure-4-from-the-paper" class="section level3">
<h3>3. Reproduce figure 4 from the paper</h3>
<p>Use the <code>plant_biomass</code> data set and reproduce figure 4 from the paper.</p>
<p>Hints:</p>
<ul>
<li>To get the right dimensions of the subplots, explore how to use the function <code>facet_grid</code> instead of <code>facet_wrap</code>.</li>
<li>Remember to search online for help, e.g. “How do I change the figure size in R markdown?”</li>
<li>You will also need to search online or in the R documentation to find out how you change the y-scale to be constant within a species, but not between species (as in the paper figure).</li>
</ul>
</div>
<div id="make-figure-3-perfect" class="section level3">
<h3>4. Make figure 3 perfect</h3>
<p>Let’s try to bring figure 3 closer to the paper version. Use the R documentation and search online to find out how to:</p>
<ul>
<li>Change the size of markers in your plots and adjust them appropriately.</li>
<li>Slightly adjust the thickness of the lines.</li>
<li>Change the colors of the lines to match those online.</li>
<li>Apply a ggplot theme to make the figure background white and the overall figure appearance more like the paper version.</li>
<li>Change the x and y label to match the paper figure.</li>
</ul>
<p><em>Parts of this lesson material were taken and modified from <a href="http://datacarpentry.org">Data Carpentry</a> under their CC-BY copyright license. See their <a href="http://www.datacarpentry.org/R-ecology-lesson/03-dplyr.html">lesson page</a> for the original source.</em></p>
</div>
</div>


<hr>

<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. See the <a href="LICENSE.html">licensing</a> page for more details about copyright information.</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
